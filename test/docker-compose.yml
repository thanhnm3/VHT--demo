---
version: '2'
services:
  zk1:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
    ports:
     - "2181:2181"
    container_name: source-zookeeper
    networks:
      - kafka-test

  source-kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zk1
    ports:
      - "9092:9092"
      - "9991:9991"
    container_name: source-kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_JMX_PORT: 9991
      KAFKA_ZOOKEEPER_CONNECT: source-zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://source-kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_LOG_RETENTION_MS: 600000
      CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS: source-kafka:29092
      CONFLUENT_METRICS_REPORTER_ZOOKEEPER_CONNECT: source-zookeeper:2181
      CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS: 1
      CONFLUENT_METRICS_ENABLE: 'false'
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - kafka-test


  zk2:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2182
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
    ports:
     - "2182:2182"
    container_name: target-zookeeper
    networks:
      - kafka-test

  target-kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zk1
    ports:
      - "9093:9093"
      - "9992:9992"
    container_name: target-kafka
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_JMX_PORT: 9991
      KAFKA_ZOOKEEPER_CONNECT: target-zookeeper:2182
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://target-kafka:39092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_LOG_RETENTION_MS: 600000
      CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS: target-kafka:39092
      CONFLUENT_METRICS_REPORTER_ZOOKEEPER_CONNECT: target-zookeeper:2182
      CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS: 1
      CONFLUENT_METRICS_ENABLE: 'false'
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9093 --list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - kafka-test

  mm2:
    image: confluentinc/cp-kafka-connect:7.5.0
    container_name: mm2
    ports:
      - "8083:8083"
    volumes:
      - ./mm2.properties:/etc/kafka/mm2.properties
      - ./connect-log4j.properties:/usr/bin/../config/connect-log4j.properties
    command: >
      bash -c "sleep 10 && connect-mirror-maker /etc/kafka/mm2.properties"
    depends_on:
      - source-kafka
      - target-kafka
    networks:
      - kafka-test


networks:
  kafka-test:
    name: kafka-test
    driver: bridge